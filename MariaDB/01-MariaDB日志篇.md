# MariaDB 日志篇

MariaDB 中有许多变量可用于定义要记录什么以及何时记录，本文将为您概述不同的日志以及如何启用/禁用这些日志。

> 注意：存储引擎也可以具有其日志，例如：`InnoDB` 保留一个 `Undo Log` 和 `Redo Log` ，它们用于回滚和崩溃恢复。

## MariaDB 日志分类

MariaDB 日志主要分为以下四类：

| 日志分类     | 日志描述                                                                                                               |
| ------------ | ---------------------------------------------------------------------------------------------------------------------- |
| 错误日志     | 错误日志包含在服务器操作期间发生的严重错误，表损坏，启动和停止信息的记录。                                             |
| 通用查询日志 | 常规查询日志记录每个查询的记录，非常消耗资源，通常使用二进制日志替代。                                                 |
| 慢查询日志   | 慢查询日志是将执行时间很长的 SQL 查询的记录。                                                                          |
| 二进制日志   | 二进制日志包含对数据库的所有更改的记录，包括数据和结构，以及每个语句执行的时间。它由一组二进制日志文件和一个索引组成。 |

> 注意：通常我们只会开启错误日志和二进制日志

## 错误日志

错误日志包含在服务器操作期间发生的严重错误，表损坏，启动和停止信息的记录。

| 序号 | 错误日志描述                                                       |
| ---- | ------------------------------------------------------------------ |
| 01   | 始终启用                                                           |
| 02   | 通常是数据目录中的文件，但某些发行版可能会将其移动到其他位置。     |
| 03   | 所有严重错误都记录在这里。                                         |
| 04   | 可以通过设置 log_warnings 来获取要记录的警告。                     |
| 05   | 使用 mysqld_safe --syslog 选项，可以将消息复制到系统的 syslog 中。 |

### 将错误日志写入文件

设置 log_error 系统变量用于指定错误日志写入文件路径，如果未配置特定的文件名，则默认情况下会将日志写入`datadir`指定的目录中的`${hostname}.err`文件(`${hostname}`是操作系统的用户名，linux 通常是 mysql，而 windows 就是系统登陆账号名)。

> my.ini 配置如下：

```ini
[mysqld]
log_error=c:/wamp/web/logs/mariadb/err.log
```

### 配置错误日志详细信息

`log_warnings` 参数用于确定记录哪些其他警告。设置为 0 禁用其他警告日志记录。

> 注意：这并不能阻止所有警告，而是有一组核心警告将始终写入错误日志。

1. 警告级别

   `log_warnings` 级别有 `0、1、2、3、4、9` 6 种级别，数值越大所记录的警告项目越多

2. 警告级别建议

   | 环境     | 级别             | 描述                         |
   | -------- | ---------------- | ---------------------------- |
   | 开发环境 | `log_warnings=9` | 记录所有警告，帮助排除 bug   |
   | 部署环境 | `log_warnings=0` | 只记录核心警告，减少资源消耗 |

> my.ini 配置如下：

```ini
[mysqld]
log_warnings=0
```

## 二进制日志

| 序号 | 概念                                                                                                                                |
| ---- | ----------------------------------------------------------------------------------------------------------------------------------- |
| 01   | 通过使用 `--log-bin` 启动 `mysqld` 来启用                                                                                           |
| 02   | 在已经或可能成为复制主服务器的计算机上使用。                                                                                        |
| 03   | 时间点恢复是必需的。                                                                                                                |
| 04   | 二进制日志文件主要由复制使用，也可以与 `mysqlbinlog` 一起使用以应用于备份以使数据库更新。                                           |
| 05   | 可以使用`--binlog-ignore-db=database_name` 或 `--binlog-do-db=database_name` 决定要记录的内容。                                     |
| 06   | 超级用户可以通过将 `SQL_LOG_BIN` 设置为 0 来禁用连接的日志记录。但是，当它为 0 时，在此连接中所做的任何更改都不会复制到从属服务器！ |
| 07   | 有关示例，请参见使用和维护二进制日志。                                                                                              |

### 二进制日志格式

使用 `binlog_format` 来设置二进制日志格式。

> 二进制日志事件支持三种格式：

| 格式                     | 代码      | 说明                             |
| ------------------------ | --------- | -------------------------------- |
| 基于 sql 语句记录（SBR） | STATEMENT | 有些语句会无法确定，复制不安全。 |
| 基于行记录（RBR）        | ROW       | 执行非确定性语句会更安全。       |
| 混合模式（MBR）          | MIXED     | 前两者结合体                     |

> 提示：mixed 让系统自行判断该基于哪种模式，也是 MariaDB 的默认值！

### 二进制日志变量

二进制日志变量非常多，这里只介绍几个 my.ini 会用到的，具体请查阅 [官方手册](https://mariadb.com/kb/en/library/replication-and-binary-log-system-variables)

| 变量             | 描述                                                                                  |
| ---------------- | ------------------------------------------------------------------------------------- |
| log_bin          | 是否启用二进制日志记录，并指定二进制日志文件存放路径                                  |
| log_bin_index    | 保存最后一个二进制日志文件名称的文件，也就是索引文件。                                |
| expire_logs_days | 多少天之后自动删除二进制日志。默认 0，表示不会自动删除。取值范围：`0-99`              |
| server_id        | mariadb 集群在复制二进制日志时，每台 MariaDB 服务器的 sercer_id 值不一样，默认值：`1` |
| binlog_format    | 确定复制是基于行，基于语句还是混合的。默认：`MIXED`                                   |

> my.ini 配置：

```ini
[mysqld]
log_bin="c:/wamp/web/data/bin-log"
log_bin_index="c:/wamp/web/data/bin-log.index"
binlog_format="mixed"
expire_logs_days=30
server_id=2
```

## `innodb` 日志

`InnoDB存储引擎` 产生的日志，我们又称 `重做日志文件`，记录了对于 `InnoDB存储引擎` 的事务日志。

> 默认：情况下会有两个日志文件 `ib_logfile0` `ib_logfile1`。

### 重做日志文件的必要性

重做日志文件的主要目的是：万一实例或者介质失败（media failure），重做日志文件就能派上用场。

> 如：数据库由于所在主机断电导致实例失败，`InnoDB存储引擎`会使用重做日志恢复到掉电前的时刻，以此来保证数据的完整性。

### 重做日志概述

每个 `InnoDB存储引擎`至少有 1 个`重做日志文件组`（group），每个文件组下至少有 2 个重做日志文件，如默认的` ib_logfile0``、ib_logfile1 `。

> 为了得到更高的可靠性，你可以:

| 设置多个镜像日志组（mirrored log groups），将不同的文件组放在不同的磁盘上。            |
| -------------------------------------------------------------------------------------- |
| 日志组中每个重做日志文件的大小一致，并以循环方式使用。                                 |
| `InnoDB存储引擎` 先写重做`日志文件 1`，当达到文件的最后时，会切换至`重做日志文件 2` 。 |
| 当`重做日志文件 2` 也被写满时，会再切换到重做`日志文件 1` 中。                         |

### 重做日志相关变量

> `innodb` 相关变量请查阅[MariaDB 官网](https://mariadb.com/kb/en/library/innodb-system-variables/)

| 变量                         | 描述                                                                      |
| ---------------------------- | ------------------------------------------------------------------------- |
| `innodb_log_file_size`       | 指定了重做日志文件的大小；                                                |
| `innodb_log_files_in_group`  | 指定了日志文件组中重做日志文件的数量，默认：`2`；                         |
| `innodb_mirrored_log_groups` | 指定了日志镜像文件组的数量，默认：`1`，代表只有一个日志文件组，没有镜像； |
| `innodb_log_group_home_dir`  | 指定了日志文件组所在路径，默认在数据库路径下。                            |

> 指令：`show variables like 'innodb%log%';` 用于查看重做日志组的配置

- my.ini 增加内容：

  ```ini
  [mysqld]
  innodb_log_group_home_dir="c:/wamp/web/data/"
  ```

  > 提示：默认情况下也是 `c:/wamp/web/data/` 目录，如果不是特定目录，不必设置。
